version: '3.7'
services:
  web:
    build: .
    ports: ['5000:5000']
    volumes:
      - type: bind
        source: ./app
        target: /app
      - type: bind
        source: ./tests
        target: /tests
      - type: bind
        source: ./migrations
        target: /migrations
      - type: bind
        source: ./cli/cli
        target: /cli
      - type: bind
        source: ./cli/setup.py
        target: /setup.py
    command: flask run --host 0.0.0.0 --port 5000
    environment:
      PORT: 5000
      FLASK_APP: app
      FLASK_ENV: development
      PYTHONPATH: /
      DATABASE_URL: postgresql://developer:notsecret@postgres:5432/development
      QUICKSPLIT_API_URL: http://web:5000
  release:
    build:
      dockerfile: Dockerfile.release
      context: .
    environment:
      FLASK_APP: app
      FLASK_ENV: development
      PYTHONPATH: /
      DATABASE_URL: postgresql://developer:notsecret@postgres:5432/development
    depends_on:
      - web
      - postgres
    volumes:
      - type: bind
        source: ./app
        target: /app
      - type: bind
        source: ./tests
        target: /tests
      - type: bind
        source: ./migrations
        target: /migrations
      - type: bind
        source: ./cli/cli
        target: /cli
      - type: bind
        source: ./cli/setup.py
        target: /setup.py
  postgres:
    image: postgres:12-alpine
    environment:
      POSTGRES_USER: developer
      POSTGRES_PASSWORD: notsecret
      POSTGRES_DB: development
